// NES MK1 v2.0
// Copyleft Mojon Twins 2013, 2015, 2017, 2018

// ..\dev\assets\mscnes.h - Script pools and scripts interpreter
// generated by mscMK1 1.1 by the Mojon Twins

const unsigned char script_pool_0 [] = {
/*            0     1     2     3     4     5     6     7     8     9     A     B     C     D     E     F */
/* 0000 */ 0x5c, 0x00, 0x00, 0x00, 0x9a, 0x00, 0x00, 0x00, 0xa8, 0x00, 0x00, 0x00, 0xb6, 0x00, 0x00, 0x00, 
/* 0001 */ 0xc4, 0x00, 0x01, 0x01, 0x2c, 0x01, 0x00, 0x00, 0x3a, 0x01, 0x00, 0x00, 0x48, 0x01, 0x00, 0x00, 
/* 0002 */ 0x56, 0x01, 0x00, 0x00, 0x64, 0x01, 0x00, 0x00, 0xa6, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
/* 0003 */ 0xe7, 0x01, 0x00, 0x00, 0xf5, 0x01, 0x00, 0x00, 0x03, 0x02, 0x00, 0x00, 0x11, 0x02, 0x1f, 0x02, 
/* 0004 */ 0x27, 0x02, 0x00, 0x00, 0x35, 0x02, 0x00, 0x00, 0x43, 0x02, 0x00, 0x00, 0x51, 0x02, 0x00, 0x00, 
/* 0005 */ 0x91, 0x02, 0x9b, 0x02, 0xa6, 0x02, 0xfd, 0x02, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x12, 0x08, 0x00, 
/* 0006 */ 0xff, 0x20, 0x86, 0x87, 0x00, 0x01, 0x0b, 0x01, 0xff, 0x2f, 0x10, 0x08, 0x00, 0xff, 0xe3, 0x1b, 
/* 0007 */ 0x50, 0x55, 0x53, 0x48, 0x20, 0x54, 0x48, 0x45, 0x20, 0x53, 0x54, 0x41, 0x54, 0x55, 0x45, 0x20, 
/* 0008 */ 0x54, 0x4f, 0x20, 0x54, 0x48, 0x45, 0x20, 0x42, 0x41, 0x53, 0x45, 0x00, 0x01, 0x0c, 0x00, 0x01, 
/* 0009 */ 0x0d, 0x02, 0x01, 0x0e, 0x02, 0x01, 0x00, 0x00, 0xff, 0xff, 0x0c, 0x12, 0x08, 0x01, 0xff, 0x20, 
/* 000A */ 0x86, 0x87, 0x00, 0x01, 0x0b, 0x01, 0xff, 0xff, 0x0c, 0x12, 0x08, 0x02, 0xff, 0x20, 0x86, 0x87, 
/* 000B */ 0x00, 0x01, 0x0b, 0x01, 0xff, 0xff, 0x0c, 0x12, 0x08, 0x03, 0xff, 0x20, 0x86, 0x87, 0x00, 0x01, 
/* 000C */ 0x0b, 0x01, 0xff, 0xff, 0x0c, 0x12, 0x08, 0x04, 0xff, 0x20, 0x86, 0x87, 0x00, 0x01, 0x0b, 0x01, 
/* 000D */ 0xff, 0x2e, 0xf0, 0xff, 0x20, 0x01, 0x08, 0x17, 0x20, 0x02, 0x08, 0x18, 0x51, 0x09, 0x71, 0x3f, 
/* 000E */ 0xaf, 0x01, 0x10, 0x00, 0xe3, 0x18, 0x46, 0x49, 0x52, 0x53, 0x54, 0x20, 0x46, 0x4c, 0x4f, 0x4f, 
/* 000F */ 0x52, 0x20, 0x41, 0x4c, 0x4d, 0x4f, 0x53, 0x54, 0x20, 0x44, 0x4f, 0x4e, 0x45, 0x21, 0x00, 0xff, 
/* 0010 */ 0xff, 0x29, 0x10, 0x10, 0x00, 0x21, 0x01, 0x3f, 0x22, 0x61, 0xaf, 0xff, 0x01, 0x10, 0x01, 0xe3, 
/* 0011 */ 0x18, 0x56, 0x45, 0x4e, 0x44, 0x4f, 0x20, 0x4d, 0x4f, 0x54, 0x4f, 0x20, 0x53, 0x45, 0x4d, 0x49, 
/* 0012 */ 0x4e, 0x55, 0x45, 0x56, 0x41, 0x21, 0x20, 0x20, 0x20, 0x00, 0xff, 0xff, 0x0c, 0x12, 0x08, 0x09, 
/* 0013 */ 0xff, 0x20, 0x86, 0x87, 0x00, 0x01, 0x0b, 0x01, 0xff, 0xff, 0x0c, 0x12, 0x08, 0x08, 0xff, 0x20, 
/* 0014 */ 0x86, 0x87, 0x00, 0x01, 0x0b, 0x01, 0xff, 0xff, 0x0c, 0x12, 0x08, 0x07, 0xff, 0x20, 0x86, 0x87, 
/* 0015 */ 0x00, 0x01, 0x0b, 0x01, 0xff, 0xff, 0x0c, 0x12, 0x08, 0x06, 0xff, 0x20, 0x86, 0x87, 0x00, 0x01, 
/* 0016 */ 0x0b, 0x01, 0xff, 0xff, 0x0d, 0x12, 0x08, 0x05, 0xff, 0x20, 0x86, 0x87, 0x00, 0x01, 0x0b, 0x01, 
/* 0017 */ 0xf2, 0xff, 0x32, 0x10, 0x08, 0x05, 0xff, 0x70, 0x63, 0xe3, 0x1c, 0x59, 0x4f, 0x55, 0x20, 0x47, 
/* 0018 */ 0x45, 0x54, 0x20, 0x54, 0x4f, 0x20, 0x54, 0x48, 0x45, 0x20, 0x53, 0x45, 0x43, 0x4f, 0x4e, 0x44, 
/* 0019 */ 0x20, 0x46, 0x4c, 0x4f, 0x4f, 0x52, 0x21, 0x00, 0x01, 0x0c, 0x09, 0x01, 0x0d, 0x0e, 0x01, 0x0e, 
/* 001A */ 0x01, 0x01, 0x00, 0x05, 0xff, 0xff, 0x0d, 0x12, 0x08, 0x0a, 0xff, 0x20, 0x86, 0x87, 0x00, 0x01, 
/* 001B */ 0x0b, 0x01, 0xf2, 0xff, 0x31, 0x10, 0x08, 0x0a, 0xff, 0xe3, 0x1b, 0x59, 0x4f, 0x55, 0x20, 0x47, 
/* 001C */ 0x45, 0x54, 0x20, 0x54, 0x4f, 0x20, 0x54, 0x48, 0x45, 0x20, 0x54, 0x48, 0x49, 0x52, 0x44, 0x20, 
/* 001D */ 0x46, 0x4c, 0x4f, 0x4f, 0x52, 0x21, 0x00, 0x01, 0x0c, 0x0a, 0x01, 0x0d, 0x02, 0x01, 0x0e, 0x01, 
/* 001E */ 0x01, 0x00, 0x0a, 0x70, 0x63, 0xff, 0xff, 0x0c, 0x12, 0x08, 0x0b, 0xff, 0x20, 0x86, 0x87, 0x00, 
/* 001F */ 0x01, 0x0b, 0x01, 0xff, 0xff, 0x0c, 0x12, 0x08, 0x0c, 0xff, 0x20, 0x86, 0x87, 0x00, 0x01, 0x0b, 
/* 0020 */ 0x01, 0xff, 0xff, 0x0c, 0x12, 0x08, 0x0d, 0xff, 0x20, 0x86, 0x87, 0x00, 0x01, 0x0b, 0x01, 0xff, 
/* 0021 */ 0xff, 0x0c, 0x12, 0x08, 0x12, 0xff, 0x20, 0x86, 0x87, 0x00, 0x01, 0x0b, 0x01, 0xff, 0xff, 0x06, 
/* 0022 */ 0x20, 0x01, 0x0c, 0xff, 0xf1, 0xff, 0xff, 0x0c, 0x12, 0x08, 0x11, 0xff, 0x20, 0x86, 0x87, 0x00, 
/* 0023 */ 0x01, 0x0b, 0x01, 0xff, 0xff, 0x0c, 0x12, 0x08, 0x10, 0xff, 0x20, 0x86, 0x87, 0x00, 0x01, 0x0b, 
/* 0024 */ 0x01, 0xff, 0xff, 0x0c, 0x12, 0x08, 0x0f, 0xff, 0x20, 0x86, 0x87, 0x00, 0x01, 0x0b, 0x01, 0xff, 
/* 0025 */ 0xff, 0x0d, 0x12, 0x08, 0x0e, 0xff, 0x20, 0x86, 0x87, 0x00, 0x01, 0x0b, 0x01, 0xf2, 0xff, 0x30, 
/* 0026 */ 0x10, 0x08, 0x0e, 0xff, 0xe3, 0x1a, 0x59, 0x4f, 0x55, 0x20, 0x47, 0x45, 0x54, 0x20, 0x54, 0x4f, 
/* 0027 */ 0x20, 0x54, 0x48, 0x45, 0x20, 0x4c, 0x41, 0x53, 0x54, 0x20, 0x46, 0x4c, 0x4f, 0x4f, 0x52, 0x21, 
/* 0028 */ 0x00, 0x01, 0x0c, 0x13, 0x01, 0x0d, 0x0d, 0x01, 0x0e, 0x01, 0x01, 0x00, 0x0e, 0x70, 0x63, 0xff, 
/* 0029 */ 0xff, 0x08, 0xf0, 0xff, 0x70, 0x63, 0x01, 0x08, 0x00, 0xff, 0xff, 0x09, 0xf0, 0xff, 0x01, 0x0a, 
/* 002A */ 0x00, 0x01, 0x0b, 0x00, 0xff, 0xff, 0x0f, 0x60, 0x10, 0x01, 0x0d, 0xff, 0x10, 0x0a, 0x01, 0xe0, 
/* 002B */ 0x03, 0x20, 0x82, 0x83, 0x1e, 0xff, 0x37, 0x10, 0x0a, 0x89, 0x10, 0x0b, 0x00, 0xff, 0x01, 0x0b, 
/* 002C */ 0x01, 0x20, 0x86, 0x87, 0x00, 0xe0, 0x07, 0x10, 0x08, 0x01, 0x01, 0x05, 0x0d, 0xe3, 0x1d, 0x47, 
/* 002D */ 0x41, 0x54, 0x45, 0x20, 0x4f, 0x50, 0x45, 0x4e, 0x21, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 
/* 002E */ 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x00, 0xff, 0x04, 0x60, 
/* 002F */ 0xff, 0xf2, 0xff, 0x08, 0x20, 0x84, 0x85, 0xff, 0xe0, 0x02, 0x6f, 0xff, 0xff, 0x14, 0xf0, 0xff, 
/* 0030 */ 0xe0, 0x02, 0xe4, 0x00, 0x70, 0x63, 0x31, 0x01, 0x01, 0x08, 0x80, 0x74, 0x68, 0x8d, 0x8e, 0x6d, 
/* 0031 */ 0x8c, 0xff, 0xff
};

const unsigned char * const script_pool [] = {
    script_pool_0
};

#ifdef CLEAR_FLAGS
void msc_clear_flags (void) {
    memfill (flags, 0, MAX_FLAGS);
}
#endif

unsigned char read_byte (void) {
    return *script ++;
}

unsigned char read_vbyte (void) {
    sc_c = *script ++;
    if (sc_c & 128) return flags [sc_c & 127];
    return sc_c;
}

void readxy (void) {
    sc_x = read_vbyte ();
    sc_y = read_vbyte ();
}

void reloc_player (void) {
    prx = read_vbyte () << 4;        px = prx << FIXBITS;
    pry = (read_vbyte () << 4) + 16; py = pry << FIXBITS;
}

void run_script (unsigned char whichs) {
    // read address offset from index
    gp_gen = (unsigned char *) script_pool [level] + (whichs << 1);
    rda = *gp_gen ++; rdb = *gp_gen;
    script_result = 0;
    if (!(rda | rdb)) return;
    script = (unsigned char *) script_pool [level] + rda + (rdb << 8);

    while ((sc_c = read_byte ()) != 0xff) {
        next_script = script + sc_c;
        sc_terminado = sc_continuar = 0;
        while (!sc_terminado) {
            switch (read_byte ()) {
                case 0x10: readxy (); sc_terminado = (flags [sc_x] != sc_y); break;
                case 0x12: readxy (); sc_terminado = (flags [sc_x] <= sc_y); break;
                case 0x20: readxy (); sc_x <<= 4; sc_y = 16 + (sc_y << 4); sc_terminado = (!(prx + 7 >= sc_x && prx <= sc_x + 15 && pry + 15 >= sc_y && pry <= sc_y + 15)); break;
                case 0x21: sc_terminado = (!(prx >= read_byte () && prx <= read_byte ())); break;
                case 0x22: sc_terminado = (!(pry >= read_byte () && pry <= read_byte ())); break;
                case 0x60: sc_terminado = (!just_pushed); break;
                case 0xf0: break;
                case 0xff: sc_terminado = sc_continuar = 1; break;
            }
        }

        if (sc_continuar) {
            fire_script_success = 1;
            sc_terminado = 0;
            while (!sc_terminado) {
                switch (read_byte ()) {
                    case 0x01: readxy (); flags [sc_x] = sc_y; break;
                    case 0x20: readxy (); _x = sc_x; _y = sc_y; _t = read_vbyte (); map_set (); break;
                    case 0x51: f_zone_ac = 1; fzx1 = read_byte (); fzy1 = read_byte (); fzx2 = read_byte (); fzy2 = read_byte (); break;
                    case 0x68: reloc_player (); break;
                    case 0x74: player_stop (); break;
                    case 0x70: timer = read_vbyte (); break;
                    case 0x10: readxy (); flags [sc_x] += sc_y; break;
                    case 0x31: plife -= read_vbyte (); break;
                    case 0xe3: _x = LINE_OF_TEXT_X; _y = LINE_OF_TEXT; gp_gen = script; sc_n = read_byte (); script += (sc_n + 1); pr_ul_str (); break;
                    case 0x6d: n_pant = read_vbyte (); on_pant = 0xfe; break;
                    case 0x6f: on_pant = 0xfe; break;
                    case 0xe4: do_extern_action (read_byte ()); break;
                    case 0xe0: sfx_play (read_vbyte (), 1); break;
                    case 0xf1: script_result = 1; return;
                    case 0xf2: return;
                    case 0xff: sc_terminado = 1; break;
                }
            }
        }
        script = next_script;
    }
}
